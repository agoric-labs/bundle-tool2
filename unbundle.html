<head>
  <title>Bundle Explorer - Agoric</title>
  <style>
    .report {
      border-collapse: collapse;
      font-family: sans-serif;
    }

    .report tr:nth-child(odd) {
      background-color: #fff;
    }

    .report tr:nth-child(even) {
      background-color: #eee;
    }

    th,
    td {
      border: 1px solid black;
      padding: 4px;
    }
  </style>
</head>
<h1>Agoric Bundle Explorer</h1>
<fieldset>
  <legend>Explore Transaction</legend>
  <label>txHash: <small><input name="txHash" /></small></label>
  <small>of InstallBundle tx</small>
  <br />
  <label>node: <input name="node" value="devnet.api.agoric.net" /></label>
  <br />
  <button type="button" onclick="exporeTx()">Explore</button>
</fieldset>
<fieldset>
  <legend>Explore File</legend>
  <label title="endoZipBase64 in .json format">File: <input type="file" name="bundleFile"
      onchange="exploreFile()" /></small></label>
</fieldset>
<fieldset>
  <label>sha512: <small><input name="sha512" size="128" readonly /></small></label>
  <br />
  <label>stored size: <input name="storedSize" readonly /> bytes</label>
  <br />

  <label>storage price:
    <input name="storagePrice" value="0.002" readonly /> IST/byte</label>
  <small><em>(TODO: fetch dynamically from chain)</em></small>
  <br />

  <label>storage cost: <input name="storageFee" readonly /> IST</label>
  <br />
</fieldset>

<section id="sec-compartments">
  <h2>Compartments</h2>
  <label>entry: <input name="entry" readonly size="120" /></label>
</section>

<section>
  <h2>Files</h2>
  <table class="report">
    <thead>
      <tr>
        <th>Size</th>
        <th>Module</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<body>
  <script type="module">
    import { Cosmos, Agoric } from './unbundle.js';
    import { makeDocTools } from './docTools.js';

    const { entries } = Object;
    const { $, $field, elt, setChoices } = makeDocTools(document);

    const queryInstallBundleTxs = async () => {
      const node = $field('node').value;
      const txs = await Agoric.queryBundleInstalls(node);
      console.log('query', txs);
      setChoices($field('txCandidates'), txs, 'txHash', 'txHash');
    };

    const fileInput = $field('bundleFile');

    const exploreFile = async () => {
      console.log('exploreFile', fileInput);

      console.log('files chosen', fileInput.files)
      const [file] = fileInput.files;

      if (file) {
        const text = await file.text();
        console.log('File:', text.length, text.slice(0, 80));
        const bundle = JSON.parse(text);
        const storedSize = text.length;
        exploreBundle(bundle, storedSize);
      }
    }

    const exporeTx = async () => {
      console.log('explore');
      const txHash = $('input[name="txHash"]').value;
      const node = $('input[name="node"]').value;
      const [m0] = await Cosmos.txMessages(txHash, node);
      const { bundle, size: storedSize } = await Agoric.getBundle(m0);
      await exploreBundle(bundle, storedSize);
    };

    const exploreBundle = async (bundle, storedSize) => {
      const { endoZipBase64Sha512: sha512 } = bundle;
      $('input[name="sha512"]').value = sha512;
      const storagePrice = parseFloat($('input[name="storagePrice"]').value);
      $('input[name="storedSize"]').value = storedSize;
      $('input[name="storageFee"]').value = storedSize * storagePrice;

      const loader = await Agoric.getZipLoader(bundle);

      const cmap = loader.extractAsJSON('compartment-map.json');
      $('input[name="entry"]').value = JSON.stringify(cmap.entry);
      // TODO: cmap.compartments
      // cmap.tags ???

      const { files } = loader;

      const tbody = $('tbody');
      let totalSize = 0;
      for (const name of Object.keys(files)) {
        const size = loader.extractAsText(name).length;
        console.log(size, name);
        const row = elt('tr', {}, [
          elt('td', {}, [`${size}`]),
          elt('td', {}, [name]),
        ]);
        tbody.appendChild(row);
        totalSize += size;
      }
    };

    // "export"
    Object.assign(globalThis, { queryInstallBundleTxs, exploreFile, exporeTx });
  </script>
</body>